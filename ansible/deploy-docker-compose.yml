---
- hosts: appservers
  become: yes
  vars:
    app_dir: /home/{{ ansible_user }}/rhythm
    mysql_root_password: Rhythm@2024Secure
    mysql_user: rhythm_user
    mysql_password: Rhythm@2024Secure
    mysql_database: rhythm
    
  tasks:

  - name: Update apt cache (Ubuntu/Debian)
    apt:
      update_cache: yes
    when: ansible_os_family == "Debian"
    ignore_errors: yes

  - name: Install required packages
    package:
      name:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg
        - lsb-release
      state: present
    when: ansible_os_family == "Debian"
    ignore_errors: yes

  - name: Add Docker GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present
    when: ansible_os_family == "Debian"
    ignore_errors: yes

  - name: Add Docker repository
    apt_repository:
      repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
      state: present
    when: ansible_os_family == "Debian"
    ignore_errors: yes

  - name: Install Docker
    package:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
      state: present
    ignore_errors: yes

  - name: Ensure docker service is running
    service:
      name: docker
      state: started
      enabled: yes

  - name: Install Docker Compose
    get_url:
      url: https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64
      dest: /usr/local/bin/docker-compose
      mode: '0755'

  - name: Add user to docker group
    user:
      name: "{{ ansible_user }}"
      groups: docker
      append: yes

  - name: Create application directory
    file:
      path: "{{ app_dir }}"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '0755'

  - name: Copy docker-compose file
    copy:
      src: ../docker-compose.yml
      dest: "{{ app_dir }}/docker-compose.yml"
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '0644'

  - name: Copy backend code
    synchronize:
      src: ../back/
      dest: "{{ app_dir }}/back/"
      delete: yes
      recursive: yes

  - name: Copy frontend code
    synchronize:
      src: ../front/
      dest: "{{ app_dir }}/front/"
      delete: yes
      recursive: yes

  - name: Create .env file for backend
    copy:
      content: |
        SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/{{ mysql_database }}
        SPRING_DATASOURCE_USERNAME={{ mysql_user }}
        SPRING_DATASOURCE_PASSWORD={{ mysql_password }}
        SPRING_MAIL_HOST=smtp.gmail.com
        SPRING_MAIL_PORT=587
        JWT_SECRET=MySecretKey123456789012345678901234567890
      dest: "{{ app_dir }}/back/.env"
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '0600'

  - name: Stop existing containers
    shell: docker-compose down
    args:
      chdir: "{{ app_dir }}"
    ignore_errors: yes

  - name: Pull latest images (if using registry)
    shell: docker-compose pull
    args:
      chdir: "{{ app_dir }}"
    ignore_errors: yes

  - name: Build and start containers
    shell: docker-compose up -d --build
    args:
      chdir: "{{ app_dir }}"

  - name: Wait for services to be healthy
    wait_for:
      host: localhost
      port: "{{ item }}"
      delay: 10
      timeout: 300
    loop:
      - 80
      - 8081
      - 3307

  - name: Show running containers
    shell: docker-compose ps
    args:
      chdir: "{{ app_dir }}"
    register: docker_ps

  - name: Display running containers
    debug:
      var: docker_ps.stdout_lines